

%% Lee
%% In dissertation, change section* to chapter and subsection* to section


\chapter{System Overview}
\label{chap-five}
\label{sec:System Overview}
As mentioned in Section \ref{sec:Motivation}, this work's target application implements multiple \acp{ann}, each of which have limited opportunities for both weight reuse and batch processing.
These applications require \ac{dram} to be employed for main storage of \ac{ann} parameters and local \ac{sram} is of limited use.
Under these conditions, the \ac{dram} bandwidth is the system bottleneck.

This work proposes employing \ac{3dic} technology along with a customized \ac{3ddram} with a very wide data-bus to meet the system requirements. 
This work is able to maintain a significantly higher bandwidth over existing \ac{asic} or \ac{asip} solutions by physically staying within the \ac{3dic} footprint and taking advantage of high density \acp{tsv}.
The objective is to demonstrate that a pure \ac{3dic} system can implement multiple disparate \acp{ann} within reasonable power and area constraints. 
The \ac{3dic} system die stack (figure \ref{fig:3DICStack}) includes the \ac{3d}-\ac{dram} with a system manager below and one or more processing layers below the manager.
\begin{figure}[!t]
% the [] contains position info e.g. [!t] means here
\centering
\captionsetup{justification=centering}
\captionsetup{width=.9\linewidth}
\centerline{
\mbox{\includegraphics[width=.9\linewidth]{StackDiagram}}
}
\caption{3DIC System Stack}
\label{fig:3DICStack}
\end{figure}

3D-DRAM has recently become available in standards such as \ac{hbm} and \ac{hmc} and proprietary devices such as the DiRAM4 available from Tezzaron. 
These technologies provide high capacity within a small footprint.
In the case of \ac{hmc}, \ac{hbm} and \ac{diram4} \cite{tezzaron:diram4}, the technology can be combined with additional custom layers to provide a system solution.

The question becomes, can a useful system coexist within the same 3D footprint?

This work targeted a baseline system with:
\begin{outline}
  \1 Computations requiring \ac{binary32}
  \1 Tezzaron \acf{diram4} \cite{tezzaron:diram4} for main memory
  \1 28nm \ac{asic} technology
\end{outline}
The work includes customizing the interface to a 3D-\ac{dram}, researching data structures to describe storage of \ac{ann} parameters, designing a memory manager with unique micro-coded instructions and a \ac{pe} layer.  
The targeted 3D-\ac{dram}, the Tezzaron \ac{diram4} employs 64 disjoint memories arranged in a physical array.
A physical layout of the \ac{diram4} can be seen in Figure \ref{fig:diram4Layout} and the key characteristics are shown in Table \ref{tab:DiRAM4 characteristics} in Appendix \ref{sec:DiRAM4 Characteristics}. 


\section{Sub-System Column}
\label{sec:Sub-System Column}

The overall system is constructed from an array of sub-systems known as a \acf{ssc} that combines the manager logic, \ac{dram} and \ac{pe} logic.
The various steps to process an \ac{ann} are provided in the form of instructions (see section \ref{sec:Instructions}). 
The instructions are downloaded by a host system to instruction memory residing in the manager.
The manager decodes these instructions and based on the instruction contents is responsible for coordinating \ac{ssc} operations and managing the reading and writing of \ac{dram}.
With the processing of an \ac{an}, the manager reads pre-synaptic states and connection weights from the \ac{dram}, provides that data to the \ac{pe} which operates on data and returns any results back to the manager.
There are other instructions that specifically deal with coordination between \acp{ssc} but the main workload is the processing of the \acp{an}.

To allow future modifications to support different number formats, different \ac{pe} configurations and to allow additional features to be implemented without a significant increase in logic area,
the \ac{ssc} has been designed for extensibility.
The \ac{ssc} is designed to operate on one of the disjoint sub-memories within the \ac{diram4} (see Figure \ref{fig:diram4Layout}).
As shown in Figure \ref{fig:SSC}, the \ac{ssc} includes the \ac{diram4} sub-memory (referred to as the \ac{ssc} memory), a manager module and a \ac{pe} module.
\begin{figure}
\centering
\begin{subfigure}{.44\textwidth}
  \centering
  \includegraphics[scale=0.75]{SSC_logical}
  \captionsetup{justification=centering, skip=10pt}
  \vspace{-6pt}
  \caption{Sub-system column logical block diagram}
  \label{fig:Sub-system Column Logical Block Diagram}
\end{subfigure}%
\begin{subfigure}{.54\textwidth}
  \centering
  \includegraphics[scale=0.9]{SSC_physical}
  \captionsetup{justification=centering, skip=10pt}
  %\vspace{36pt}
  \vspace{20pt}
  \caption{Sub-system column physical diagram}
  \label{fig:Sub-system Column Physical Diagram}
\end{subfigure}
\captionsetup{justification=centering, skip=12pt}
\caption{\acf{ssc}}
\label{fig:SSC}
\end{figure}

The customizations described in Section \ref{sec:Very-Wide Bus} means each \ac{ssc} memory provides the manager with a 2048-bit \ac{ddr} data bus.
The \ac{diram4} has 64 sub-memories so there are 64 \acp{ssc}. 
The \ac{ssc} has been designed as a standalone unit and does not have a direct knowledge of the other \acp{ssc} in the system and any required coordination between \acp{ssc} is embedded within an instruction rather than in the hardware.

To process an \ac{ann}, the user must allocate the individual \acp{an} to an \ac{ssc}. 
Once partitioned, an \ac{ann}'s pre-synaptic connection weights must be stored in the \ac{ssc} memory associated with the \ac{an}.
The states of the pre-synaptic \acp{an} must also be stored in a dependent \ac{an}'s allocated \ac{ssc} memory.
Details on where the parameters and \ac{an} states are stored are described in Chapter \ref{sec:System Operations}.

The baseline \ac{ssc} is designed with 32 execution lanes, each of which can simultaneously process two streams of \ac{binary32} words.
The customized \ac{diram4} provides a 2048-bit cache line at the system clock rate to the manager. This 2048-bit bus is sub-divided into 64 \ac{binary32} words.
The manager layer reads the 2048-bit cache line from the \ac{dram}, multiplexes the 64 words onto 32 execution lanes with two words per execution lane and passes the execution lane data to the \ac{pe} layer.
The primary function is to direct a pre-synaptic \ac{an} state and connection weight to the two words in an execution lane where they are multiplied and accumulated by the \ac{pe} layer.

The manager layer has individual stream read memory controllers to allow the individual streams in the execution lanes to operate independently.
In this way, the \ac{an} states and the connection weights can be stored in different configurations depending on the \ac{ann} type and \ac{ann} partitioning.
The 32 execution lanes can be used for processing a group of one to 32 individual \acp{an} or for processing one \ac{an}.

\section{Processing a group of \acp{an}}
\label{sec:Processing a group of ANes}

In the case of a group of \acp{an}, all the \acp{an} must be associated with a \ac{roi} or a fully-connected layer.
The pre-synaptic \ac{roi}, or all the \acp{an} in the case of a fully-connected layer, are broadcast to one of the streams of all execution lanes.
The other stream is used for the individual \ac{an}'s connection weights. 
The \ac{pe} \ac{stop} performs 32 simultaneous \acf{fp} \ac{mac} operations while the data is being streamed from the manager layer to the \ac{pe} layer.
Once all the \ac{an} states and weights have been streamed to the \ac{pe}, the \ac{stop} passes the result of the \ac{mac} to the \ac{pe} \ac{simd} that then applies the activation function.
Typically the \ac{simd} then sends states of the group of \acp{an} back to the manager.

Considering the \ac{roi} pre-synaptic \ac{an} states and weights for $k$th \ac{an} as arrays $\left[A\right]$ and $\left[W_k\right]$ with elements $A_p$ and $W_{k,p}$ respectively, the state of the \ac{an} is the dot-product of the two arrays followed by the activation function \eqref{eq:AN dot-product function}.

%Considering the array and how the weights and states are directed to execution lanes are shown in Figure \ref{fig:AN group multiplexing}.
Figure \ref{fig:AN group multiplexing} shows how the group's weights and states are directed to execution lanes. 

%\vspace{-1cm}
\begin{alignat}{2} 
  \label{eq:AN dot-product function}
  \text{State of $k$th \ac{an},} \quad S_k  &= f\big(\left[W\right] \mathbf{\cdot} \left[A\right]\big)  \\
  \text{where } &\mathbf{W}=\left[w_{k,0}, w_{k,1}, \dots w_{k,n} \right], \quad \mathbf{A}=\left[a_0, a_1, \dots a_n \right] \notag \\
  \text{and } &n \text{ is the pre-synaptic fanin              \notag }
\end{alignat}

\begin{figure}[h]
\centering
\begin{subfigure}{.49\textwidth}
  \centering
  \includegraphics[scale=0.75]{groupANmultiplexing}
  \captionsetup{justification=centering, skip=10pt, width =1\textwidth}
  %\vspace{-6pt}
  \caption{Multiplexing \ac{dram} data for a \ac{an} group\\ $k \in 0 \dots 31 $} 
  \label{fig:AN group multiplexing}
\end{subfigure}%
\begin{subfigure}{.49\textwidth}
  \centering
  \includegraphics[scale=0.75]{singleANmultiplexing}
  \captionsetup{justification=centering, skip=10pt, width =1\textwidth}
  %\vspace{-6pt}
  \caption{Multiplexing \ac{dram} data for a single \ac{an}\\ $k=0$} 
  \label{fig:Single AN multiplexing}
\end{subfigure}
\captionsetup{justification=centering, skip=12pt}
\caption{Multiplexing \ac{dram} data to execution lanes}
\label{fig:DRAM data multiplexing}
\end{figure}

\section{Processing a single \ac{an}}
\label{sec:Processing a single ANe}

In the case of a single \ac{an}, the pre-synaptic \ac{an} states are vectored across one of the streams of all execution lanes.
The connection weights are vectored across the other stream of all the execution lanes.
How the weights and states are directed to execution lanes is shown in Figure \ref{fig:Single AN multiplexing}.

%An overview of the various blocks and interconnects in the \ac{ssc} is given in Section \ref{sec:SSC Blocks} with additional detail provided in Chapter \ref{sec:Detailed System Description}.

% ----------------------------------------------------------------------------------------------------
\section{\acf{ssc} Blocks}
\label{sec:SSC Blocks}

\subsection{Customized \ac{dram} : \acf{diram4}}
\label{sec:3ddram}
The \ac{diram4} \cite{tezzaron:diram4} employs multiple memory array layers in conjunction with a control and IO layer.
The memory is formed from 64 disjoint sub-memories each providing upwards of \SI[per-mode=symbol]{1}{\giga\bit} with a total capacity of at least \SI[per-mode=symbol]{64}{\giga\bit}.
Unlike traditional \ac{dram}, the \ac{diram4} has two independent channels that are accessed using \ac{ddr} signaling on the control signals.
Each channel has 32 banks and 4096 pages per bank with \SI[per-mode=symbol]{4096}{\bit\per page}.
The key characteristics of the \ac{diram4} are shown in Table \ref{tab:DiRAM4 characteristics} in Appendix \ref{sec:DiRAM4 Characteristics}. 

The standard \ac{diram4} has a 32-bit read databus and a 32-bit write databus enabling simultaneous read and write. Both read and write databuses employ \ac{ddr} signaling.
The read and write transactions are burst-of-two providing 64 bits per read/write. When accessing a \ac{dram}, a read and write are often referred to as a cache line.
The device is designed to operate at \SI[per-mode=symbol]{1}{\giga\hertz} although this work targeted a \SI[per-mode=symbol]{500}{\mega\hertz} clock frequency.

This work is proposing customizations to the \ac{diram4} which are outlined in Section \ref{sec:DRAM Customizations}. One of these proposed changes is to widen the read and write databuses to 2048-bits.
Using the same burst-of-two means each read and write will access an entire page. A cache line becomes 4096-bits.
Another proposed change is to add mask bits to the write databus to avoid having to perform read/modify/writes when writing back data much smaller than the new large cache line.

\begin{figure}[!t]
% the [] contains position info e.g. [!t] means here
\centering
\captionsetup{justification=centering}
\captionsetup{width=.9\linewidth}
\centerline{
\mbox{\includegraphics[width=.4\linewidth]{DiRAM4Layout}}
}
\caption{\ac{dram} Physical interface layout showing area for \ac{ssc}}
\label{fig:diram4Layout}
\end{figure}


% ----------------------------------------------------------------------------------------------------
\subsection{Layer Interconnect}
\label{sec:Layer Interconnect}

To provide high connection density, high bandwidth and low energy,
the layers are connected using fine-pitch through-silicon-vias (\ac{tsv}s).
We can take advantage of the area and bandwidth benefits provided by the \acp{tsv} by ensuring the system stays within the 3D footprint.
The high density interconnect provided by \acp{tsv} allows the system to take advantage of the very wide \ac{dram} bus provided by the \ac{dram} customization described in Section \ref{sec:Very-Wide Bus}.
The wide interconnect between the manager and \ac{pe} is also implemented using \acp{tsv}.
The interconnect between the manager and \ac{pe} is referred to as the stack bus. The interconnect between the manager and \ac{dram} is referred to as the \ac{dram} bus.

\subsection{Stack Bus}
\label{sec:Stack Bus}

The stack bus is bidirectional with a 36-bit \ac{oob} configuration bus from the manager to the \ac{pe}, a 2048-bit ``downstream'' data bus from the manager to the \ac{pe} and a 128-bit ``upstream'' data bus from the \ac{pe} to the manager.

The 36-bit \ac{oob} bus is designed to send configuration packets to configure the \ac{stop} and \ac{simd} blocks inside the \ac{pe}.
A configuration packet primarily contains the \ac{stop} function to be performed on the downstream data and the operation the \ac{simd} is to perform on the result from the \ac{stop}.
It also includes the size of the downstream data stream and an operation identification tag.

The 2048-bit downstream stack bus is designed to carry 32 execution lanes of data with each execution lane containing two operand buses. 
The two operand buses are designed to carry streams of \ac{binary32} numbers.
This allows the downstream stack bus to simultaneously stream 32 execution lanes, each with two 32-bit argument streams. 
Typically these streams are the weights and pre-synaptic \ac{an} states to calculate the states of up to 32 \acp{an}. 
The streams can also be configured to calculate the state of a single \ac{an} where the weights and pre-synaptic \ac{an} states for the single \ac{an} are sent in parallel across the downstream stack bus and a reduction operation can be performed in the \ac{pe} by the \ac{stop} and \ac{simd}.

The 128-bit upstream bus is primarily designed to send the results of a downstream operation. Typically this is the state of up to 32 \acp{an}.
The upstream bus is packetized with the result data contained in the data portion of the upstream packet.
Additional information includes the operation identification tag provided by the decoder in the downstream \ac{oob} operation configuration and the number of data words.
The upstream bus is not as wide as the downstream bus because the ratio of downstream operands to result data is a function of the pre-synaptic fanin.
Based on the average fanin from the baseline \ac{ann} shown in Table \ref{tab:Baseline Layer Configuration}, a 128-bit result bus exceeds the required average bandwidth.
The stack bus \ac{oob} downstream and upstream signaling can be seen in Figure \ref{fig:Stack Bus signalling}.

\subsubsection{Common Bus Signaling}
\label{sec:Common Bus Signalling}

With almost all interfaces in this system, additional control signals are used to a) validate, b) delineate and c) flow control messaging between blocks.
This ``common'' bus protocol signal group includes three signals, VALID, CNTL and READY. 
The single VALID signal is high when the bus contains valid information. The two-bit CNTL signal is used to delineate by encoding \ac{som}, \ac{mom} and \ac{eom}.
Because of the asynchronous nature of the system, most interfaces employ small \acp{fifo}. When these \acp{fifo} are almost full, the source is flow controlled by the READY signal. 
The point at which the \ac{fifo} signals the source to stop sending is based on the latency of the particular interface. 
The common signaling protocol will be seen in all waveform diagrams as seen in Figure \ref{fig:Stack Bus signalling}.


\begin{figure}
\centering
\begin{subfigure}{.9\textwidth}
  \centering
  \includegraphics[width=0.7\textwidth]{stack_down_oob_wave_fig}
  \captionsetup{justification=centering, skip=10pt}
  \caption{Stack downstream OOB Bus}
  \label{fig:Stack downstream OOB Bus}
\end{subfigure}%

\bigskip

\begin{subfigure}{.9\textwidth}
  \centering
  \includegraphics[width=0.7\textwidth]{stack_down_wave_fig}
  \captionsetup{justification=centering, skip=10pt}
  \caption{Stack downstream Data Bus}
  \label{fig:Stack downstream Data Bus}
\end{subfigure}%

\bigskip

\begin{subfigure}{.9\textwidth}
  \centering
  \includegraphics[width=0.7\textwidth]{stack_up_wave_fig}
  \captionsetup{justification=centering, skip=10pt}
  \caption{Stack upstream Bus}
  \label{fig:Stack upstream Bus}
\end{subfigure}%

\captionsetup{justification=centering, skip=16pt}
\caption{Stack Bus signaling}
\label{fig:Stack Bus signalling}
\end{figure}


\subsection{\ac{dram} Bus}
\label{sec:DRAM Bus}

The interface to the \ac{diram4} is similar to traditional \ac{dram} interfaces with control signals including bank address and multiplexed page/cache address bus.
There are separate 2048-bit \ac{ddr} read and write databuses (see section \ref{sec:Very-Wide Bus}).
In total there are 4180 signals in the \ac{dram} interface.
Other than the wide databuses, the interface protocol is as described in \cite{tezzaron:diram4}.
A timing diagram showing a read and write to the \ac{diram4} is shown in Figure \ref{fig:diram4Timing}.
\begin{figure}[!t]
\centering
\captionsetup{justification=centering}
\captionsetup{width=.9\linewidth}
\centerline{
\mbox{\includegraphics[width=.8\linewidth]{diram4TimingDiagram}}
}
\caption{Read and Write request to \ac{diram4} \cite{tezzaron:diram4}}
\label{fig:diram4Timing}
\end{figure}



The bandwidth of the \ac{dram} bus is designed to ensure data can be constantly maintained to the stack downstream bus.
Because an entire cache line is accessed for each read request, there is an extreme case when back-to-back requests result in up to 32 \ac{dram} page open commands.
It is possible that this sequence of page opens could be followed by page closes resulting in a period when no useful data is being read from the \ac{diram4}.
This case is shown in Figure \ref{fig:Worst case PO/PC sequence}.
\begin{figure}[!t]
\centering
\captionsetup{justification=centering}
\captionsetup{width=.9\linewidth}
\centerline{
\mbox{\includegraphics[width=1\linewidth]{worstCaseDiram4Read}}
}
\caption{Worst case PO/PC sequence}
\label{fig:Worst case PO/PC sequence}
\end{figure}
To accommodate this, the \ac{dram} bus has twice the raw bandwidth of the downstream stack bus. 
Therefore under this worst case scenario the higher bandwidth data from the \ac{diram4} must be buffered, as shown in Figure \ref{fig:Worst case read path FIFO depth}.
These per channel \SI[per-mode=symbol]{32}{\kilo\bit} \acp{fifo} are placed in the read path as shown in Figure \ref{fig:DRAM Read Path Buffering}.
These \acp{fifo} are instantiated in the manager \acp{mrc} as described in Section \ref{sec:MRC}.
A question arises that if the \ac{dram} interface has to employ large local storage in the form of \acp{fifo}, why is this different from other implementations that employ large amounts of \ac{sram}?
The difference is that this \ac{fifo} storage is to accommodate the \ac{dram} interface protocol and  pipelining to allow concurrent processing and does not impose a \ac{ann} size limitation unlike systems that employ the storage in a cache-like structure.


\begin{figure}
\centering
\begin{subfigure}{.9\textwidth}
  \centering
  \includegraphics[width=0.7\textwidth]{readBufferDepth}
  \captionsetup{justification=centering, skip=0pt}
  \caption{Worst case read path FIFO depth}
  \label{fig:Worst case read path FIFO depth}
\end{subfigure}%

\bigskip

\vspace{-10pt}
\begin{subfigure}{.9\textwidth}
  \centering
  \includegraphics[width=0.75\textwidth]{readBufferBlockDiagram}
  \captionsetup{justification=centering, skip=6pt}
  \caption{Read path buffering diagram}
  \label{fig:Read path buffering diagram}
\end{subfigure}
\captionsetup{justification=centering, skip=16pt}
\caption{DRAM Read Path Buffering}
\label{fig:DRAM Read Path Buffering}
\end{figure}

\iffalse 
Each of the \ac{diram4} memories contain two channels with each channel containing 32 banks and each bank contains 4096 \SI[per-mode=symbol]{4}{\kilo\bit} pages.
\fi

% ----------------------------------------------------------------------------------------------------
\subsection{Manager Layer}
The Manager block is the main \ac{ssc} controller and the memory controller for the \ac{diram4} memory. 
The operations required to process an \ac{ann} are formed from individual instructions that are decoded by the Manager. 
These instructions (for more detail see section \ref{sec:Instructions}) are sub-divided into descriptors to describe memory read operations, processing engine operations, memory write operations and general system operations for synchronization. 
The manager reads these system instructions from an instruction memory, decodes the descriptors and configures the various blocks in the system.
The configuration includes:
\begin{itemize}
      \item Initiating operand reads from \ac{dram}
      \item Preparing the processing engine (\ac{pe}) to operate on the downstream stack bus operand streams
      \item Preparing the result processing engine to take the resulting \ac{an} activations from the \ac{pe} via the upstream stack bus and write those results back to the \ac{dram}
      \item Replicating the resulting \ac{an} activations to neighbor managers over the \ac{noc} for processing of other \ac{ann} layers
\end{itemize}

The most common instruction is to perform state calculation on a group of \acp{an}.
This instruction contains four descriptors (see Figures \ref{fig:Instruction 4-tuple} and \ref{fig:Instruction Details}), an operation descriptor, two memory read descriptors and a memory write descriptor.
\iffalse
\begin{figure}[!t]
\centering
\captionsetup{justification=centering}
\captionsetup{width=.9\linewidth}
\centerline{
\mbox{\includegraphics[width=.9\linewidth]{instruction4Tuple}}
}
\caption{Instruction 4-tuple}
\label{fig:Instruction 4-tuple}
\end{figure}
\fi
\begin{figure}[!t]
  % the [] contains position info e.g. [!t] means here
  \centering
    \captionsetup{justification=centering, skip=10pt}
    \vspace{10mm}
    \begin{bytefield}[bitwidth=0.49em, endianness=big]{64}
      %\bitheader{0,32,64,96,128} \\
      %\begin{rightwordgroup}{\scriptsize Option Cycle}
        \colorbitbox{desc!40}{16}{\scriptsize Operation \\ \vspace{-0em}descriptor} & \colorbitbox{desc!40}{16}{\scriptsize Arg0 read \\ \vspace{-0em}descriptor} & \colorbitbox{desc!40}{16}{\scriptsize Arg1 read \\ \vspace{-0em}descriptor} & \colorbitbox{desc!40}{16}{\scriptsize Result write \\ \vspace{-0em}descriptor} 
      %\end{rightwordgroup}  \\
    \end{bytefield}
\caption{Four descriptor instruction (4-tuple)}
\label{fig:Instruction 4-tuple}
\end{figure}

The operation descriptor describes the operations the \ac{pe} will perform, which typically includes a \ac{mac} to be performed by the \ac{stop} followed by a \ac{relu} \cite{maas2013rectifier} function to be performed by the \ac{simd}.
The manager extracts the operation information, embeds the information in an \ac{oob} packet and sends the packet to the \ac{pe} over the downstream \ac{oob} bus.
The two memory read descriptors are used to define the memory locations of the downstream stack data buses.
There is one memory read descriptor for each of the two-operand streams in the execution lanes.  One typically defines where the pre-synaptic weights are stored and the other defines where the pre-synaptic \ac{an} states are stored.
The architecture is designed to cause an instruction to compute the state of multiple \acp{an} or to cause an individual \ac{an}'s state to be computed.
If a group of \acp{an} is computed, the pre-synaptic connection weights for the \acp{an} are stored interleaved and when read from \ac{dram} are directed to one of the streams of each of the execution lanes.
If a single \ac{an} is computed, the pre-synaptic connection weights for the \acp{an} are stored linearly and when read from \ac{dram} are directed to one of the streams of each of the execution lanes.
The pre-synaptic \ac{an} states are stored in row-major order and when read are broadcast to the other stream of each execution lane.



% ----------------------------------------------------------------------------------------------------
\subsection{Processing Engine Layer}
\label{sec:Processing Engine Layer}
The \ac{pe} contains two main processing modules, the \ac{stop} and the \ac{simd} block.
Both the \ac{stop} block and the \ac{simd} have 32-execution lanes. The execution lanes inside the \ac{stop} contain functions required to perform \ac{an} related operations.
The \ac{simd} will be a 32 execution lane, 32-bit \ac{simd} engine based on the device described in \cite{schabel2016processor}.

The \ac{pe} is configured by the manager to perform operations on two operand data streams from the manager. 
The \ac{stop} is able to operate on this data directly from the manager at the full bandwidth rate of the stack bus so it does not have to be stored in local \ac{sram} prior to processing. 
There is a small \ac{fifo} to provide buffering to allow asynchronous configuration of the \ac{stop} block and the source of the streaming data in the manager. 
The \ac{fifo} also allows the two argument streams in each of the execution lanes to wander with respect to each other and with respect to the other lanes.

The architecture is expandable to allow various functions to be provided in the \ac{stop}.
The current baseline implementation includes the \ac{mac} operation.
There is one \ac{mac} per execution lane allowing up to 32 simultaneous pre-synaptic \ac{an} $\mbox{weight} \cdot \mbox{state}$ computations on the two operands from the two streams in each execution lane.
These computations can be for a group of up to 32 \acp{an} or for a single \ac{an} as shown in Figure \ref{fig:PE AN calculation}.

\begin{figure}
\centering
  \begin{subfigure}{.49\textwidth}
    \centering
    \includegraphics[width=0.9\textwidth]{singleANcalculation}
    \captionsetup{justification=centering, skip=10pt}
    \caption{Single ANe calculation}
    \label{fig:Single AN calculation}
  \end{subfigure}%
%\bigskip
  \begin{subfigure}{.49\textwidth}
    \centering
    %\vspace{40pt}
    \includegraphics[width=0.9\textwidth]{groupANcalculation}
    \captionsetup{justification=centering, skip=10pt}
    \caption{Group ANe calculation}
    \label{fig:Group AN calculation}
  \end{subfigure}%
%\vspace{-10pt}
\captionsetup{justification=centering, skip=16pt}
\caption{\ac{pe} \ac{an} calculation}
\label{fig:PE AN calculation}
\end{figure}

If it is for a group of \acp{an}, the \ac{simd} only has to perform the activation function on the 32 results from the \ac{stop}. 
If a single \ac{an} is being processed, the \ac{simd} must accumulate the result from each execution lane's \ac{stop} before applying the activation function.
The activation function currently implemented is the \ac{relu}.
The \ac{an} states can be sent back to the manager over the stack upstream bus or retained for further processing such as pooling or softmax calculations.

% ----------------------------------------------------------------------------------------------------
\subsection{Inter-Manager Communication}
\label{sec:Inter-Manager Communication}

An \ac{noc} provides host to \ac{ssc} and \ac{ssc} to \ac{ssc} communication.
A four port \ac{noc} within each management block is used to communicate with the host and other \acp{ssc} using a mesh network as shown in Figure \ref{fig:Mesh}.
The \ac{noc} packet format can be seen in Figure \ref{fig:NoC packet format}.

The managers in the middle of the array use all four ports to connect to adjacent managers, the managers in the corners of the array connect to two adjacent managers and the managers at the edges connect to three adjacent managers, as shown in Figure \ref{fig:Mesh}.
The host is connected to one (or more) of the managers at one edge of the array. 

During configuration and/or computations, it may be required to replicate data to other \acp{ssc}.
During \ac{an} computations, an \ac{ssc} only reads \ac{ann} weights and states from its local \ac{dram} and not \ac{dram} of other \acp{ssc}.
In some cases, such as fully-connected layers and locally-connected layers with \ac{roi} overlap, the \ac{an} computation in an \ac{ssc} for layer $n$ may include \ac{an} states from layer $n-1$ that were computed in another \ac{ssc}.
In this case, when \acp{an} are being computed for layer $n-1$, the operation instruction contains information as to where the result should be written back for computing \acp{an} in layer $n$.
If a particular layer $n-1$ \ac{an} is required by another \ac{ssc} when computing a layer $n$ \ac{an}, the result is sent to all dependent \acp{ssc} via the \ac{noc}.
The instruction contains one or more storage descriptors (see section \ref{sec:Storage Descriptor}) that identify the destination of the operation result.
If the result must be replicated, there are multiple storage descriptors. When the \ac{pe} returns the result, the manager examines the storage descriptors and determines to which \ac{ssc} the result should be sent.
The manager creates an \ac{noc} header that includes information on all the destination \acp{ssc}. 
This is encoded as a 64-bit field, although to provide extensibility the \ac{noc} header also supports a unicast address and multicast group. 
The multiple storage descriptors and the result data are placed in the data portion of the \ac{noc} packet.
As the packet traverses the \ac{noc}, it is replicated to outgoing ports based on the destination bit field.
When the destination \ac{ssc} receives the packet, it extracts the storage descriptor and writes the data to its local \ac{dram}.

\begin{figure}[!t]
% the [] contains position info e.g. [!t] means here
\centering
\captionsetup{justification=centering}
\centerline{
\mbox{\includegraphics[width=.45\linewidth]{Mesh}}
}
\caption{\ac{noc} manager connectivity}
\label{fig:Mesh}
\end{figure}

%\tiny 	
%\scriptsize 	
%\footnotesize
%\small 	
%\normalsize 	
%\large 	
%\Large 	
%\LARGE 	
\begin{figure}[!t]
  % the [] contains position info e.g. [!t] means here
  \centering
  \captionsetup{justification=centering}
  \begin{minipage}{1\textwidth}
    \centering
    \captionsetup{justification=centering, skip=10pt}
    \vspace{2mm}
    \begin{adjustbox}{width=1\textwidth}
      \begin{bytefield}[bitwidth=0.49em, endianness=big]{77}
        \bitheader{0,8,16,24,32,40,48,56,64,68,74,76} \\
        \begin{rightwordgroup}{\scriptsize Unicast Bitfield header}
          \bitbox{2}{\rotatebox{90}{\tiny SOM}} & \bitbox{7}{\scriptsize src} & \bitbox{2}{\tiny M} & \bitbox{1}{\rotatebox{90}{\tiny prio}} & \bitbox{64}{\tiny destination SSC bitfield} 
        \end{rightwordgroup}  \\
        \begin{rightwordgroup}{\scriptsize MCast Group header}
          \bitbox{2}{\rotatebox{90}{\tiny SOM}} & \bitbox{7}{\scriptsize src} & \bitbox{2}{\tiny M} & \bitbox{1}{\rotatebox{90}{\tiny prio}}  & \bitbox{58}{\tiny padding} & \bitbox{6}{\tiny gid} 
        \end{rightwordgroup}  \\
        \begin{rightwordgroup}{\scriptsize Unicast header}
          \bitbox{2}{\rotatebox{90}{\tiny SOM}} & \bitbox{7}{\scriptsize src} & \bitbox{2}{\tiny M} & \bitbox{1}{\rotatebox{90}{\tiny prio}}  & \bitbox{57}{\tiny padding} & \bitbox{7}{\tiny dest} 
        \end{rightwordgroup}  \\
        \begin{rightwordgroup}{\scriptsize Option Cycle}
          \bitbox{2}{\rotatebox{90}{\tiny MOM}} & \bitbox{1}{} & \bitbox{4}{\tiny type} & \bitbox{3}{\tiny pyld\\ \vspace{-0em} type} & \bitbox{1}{} & \bitbox{1}{\tiny P\\ V} & \colorbitbox{optiontype!40}{8}{\tiny option\\ \vspace{-0em}type} & \colorbitbox{optionvalue!40}{6}{\tiny SSC ID} & \colorbitbox{optionvalue!40}{18}{\tiny storage descriptor\\ pointer} & \colorbitbox{optiontype!40}{8}{\tiny option\\ type} & \colorbitbox{optionvalue!40}{6}{\tiny SSC ID} & \colorbitbox{optionvalue!40}{18}{\tiny storage descriptor\\ pointer}
        \end{rightwordgroup}  \\
        \begin{rightwordgroup}{\scriptsize Data Cycle}
          \bitbox{2}{\rotatebox{90}{\tiny MOM}} & \bitbox{1}{} & \bitbox{4}{\tiny type} & \bitbox{3}{\tiny pyld\\ \vspace{-0em} type} & \bitbox{1}{} & \bitbox{1}{\tiny P\\ V} & \bitbox{32}{\tiny Data} & \bitbox{32}{\tiny Data}
        \end{rightwordgroup}  \\
        \bitbox[]{76}{$\vdots$} \\[1ex]
        \begin{rightwordgroup}{\scriptsize Data Cycle}
          \bitbox{2}{\rotatebox{90}{\tiny EOM}} & \bitbox{1}{} & \bitbox{4}{\tiny type} & \bitbox{3}{\tiny pyld\\ \vspace{-0em} type} & \bitbox{1}{} & \bitbox{1}{\tiny P\\ V} & \bitbox{32}{\tiny Data} & \bitbox{32}{\tiny Data}
        \end{rightwordgroup}  \\
      \end{bytefield}
    \end{adjustbox}
    \captionsetup{justification=centering, skip=9pt}
    \vspace{-1.0cm}
    \captionof{figure}{NoC packet format}
    \label{fig:NoC packet format}
  \end{minipage}

  \vspace{0.5cm}
  \captionof{table}{NoC header cycle fields}
  \vspace{0.3cm}
  \begin{minipage}{1\textwidth}
    \centering
    \begin{minipage}{0.25\textwidth}
        \begin{adjustbox}{width=1\textwidth}
            \footnotesize
            \begin{tabular}{ |c|c|  }
              \hline
              \rowcolor{gray!50}
              \multicolumn{2}{|c|}{Source} \\
              \hline
              \rowcolor{gray!25}
              src[6:0] & Description  \\
              \hline
              $0\cdots 63 $  & Destination SSC \\
              $64$           & Host            \\
              $65\cdots 127$ & Unused          \\
              \hline
            \end{tabular}
        \end{adjustbox}
    \end{minipage}
    \begin{minipage}{0.25\textwidth}
        \begin{adjustbox}{width=1\textwidth}
            \footnotesize
            \begin{tabular}{ |c|c|  }
              \hline
              \rowcolor{gray!50}
              \multicolumn{2}{|c|}{Destination Type} \\
              \hline
              \rowcolor{gray!25}
              M[1:0] & Description  \\
              \hline
              00 & Multicast bit-field \\
              01 & Multicast group \\
              10 & Unicast \\
              \hline
            \end{tabular}
        \end{adjustbox}
    \end{minipage}
    \begin{minipage}{0.18\textwidth}
        \begin{adjustbox}{width=1\textwidth}
            \footnotesize
            \begin{tabular}{ |c|c|  }
              \hline
              \rowcolor{gray!50}
              \multicolumn{2}{|c|}{Priority} \\
              \hline
              \rowcolor{gray!25}
              prio & Description  \\
              \hline
              0     & Low priority \\
              1     & High priority \\
              \hline
            \end{tabular}
        \end{adjustbox}
    \end{minipage}
    
    \bigskip
    
    \centering
    \begin{minipage}{1\textwidth}
      \centering
      \begin{minipage}{0.25\textwidth}
          \begin{adjustbox}{width=1\textwidth}
              \footnotesize
              \begin{tabular}{ |c|c|  }
                \hline
                \rowcolor{gray!50}
                \multicolumn{2}{|c|}{Group ID} \\
                \hline
                \rowcolor{gray!25}
                gid[5:0] & Description  \\
                \hline
                $0\cdots 63$     & Group table pointer\\
                \hline
              \end{tabular}
          \end{adjustbox}
      \end{minipage}
      %\centering
      \begin{minipage}{0.25\textwidth}
          \begin{adjustbox}{width=1\textwidth}
              \footnotesize
              \begin{tabular}{ |c|c|  }
                \hline
                \rowcolor{gray!50}
                \multicolumn{2}{|c|}{Unicast Destination} \\
                \hline
                \rowcolor{gray!25}
                dest[6:0] & Description  \\
                \hline
                $0\cdots 63 $  & Destination SSC \\
                $64$          & Host            \\
                $65\cdots 127$ & Unused          \\
                \hline
              \end{tabular}
          \end{adjustbox}
      \end{minipage}
    \end{minipage}
    %\vspace{0.0cm}
    %\captionsetup{justification=centering, skip=9pt}
    %\captionsetup[table]{position=top} 
    %\captionof{table}{NoC header cycle fields}
    \label{tab:NoC header fields}
  \end{minipage}
    
  \bigskip

  \captionsetup{justification=centering, skip=9pt}
  \captionof{table}{NoC option/data cycle fields}
  \vspace{0.3cm}
  \begin{minipage}{1\textwidth}
    \centering
    \begin{minipage}{0.35\textwidth}
        \begin{adjustbox}{width=1\textwidth}
            \footnotesize
            \begin{tabular}{ |c|c|  }
              \hline
              \rowcolor{gray!50}
              \multicolumn{2}{|c|}{Transaction Type} \\
              \hline
              \rowcolor{gray!25}
              type[3:0] & Description  \\
              \hline
              0   & NOP  \\
             1-4  & NA  \\
              5   & Storage Desc Write Data \\
              8   & Configuration DMA start \\
              9   & Configuration DMA       \\
             10   & Configuration DMA end   \\
             11   & Configuration Instruction start \\
             12   & Configuration Instruction       \\
             13   & Configuration Instruction end   \\
             14   & Configuration \\
             15   & Status \\
              \hline
            \end{tabular}
        \end{adjustbox}
    \end{minipage}
    \begin{minipage}{0.25\textwidth}
        \begin{adjustbox}{width=1\textwidth}
            \footnotesize
            \begin{tabular}{ |c|c|  }
              \hline
              \rowcolor{gray!50}
              \multicolumn{2}{|c|}{Payload Type} \\
              \hline
              \rowcolor{gray!25}
              pyld type[2:0] & Description  \\
              \hline
              0   &  NOP \\
              1   &  Option tuples \\
              2   &  Data \\
              \hline
            \end{tabular}
        \end{adjustbox}
    \end{minipage}
    \begin{minipage}{0.20\textwidth}
        \begin{adjustbox}{width=1\textwidth}
            \footnotesize
            \begin{tabular}{ |c|c|  }
              \hline
              \rowcolor{gray!50}
              \multicolumn{2}{|c|}{Payload Valid} \\
              \hline
              \rowcolor{gray!25}
              PV  & Description  \\
              \hline
              0   &  One data word \\
              1   &  Two data words \\
              \hline
            \end{tabular}
        \end{adjustbox}
    \end{minipage}
    \label{tab:NoC option/data cycle fields}
  \end{minipage}
\end{figure}


\iffalse
\begin{figure}[!t]
\centering
\captionsetup{justification=centering}
\captionsetup{width=.75\linewidth}
\centerline{
\mbox{\includegraphics[width=.9\linewidth]{nocpacket}}
}
\vspace{0pt}
\caption{\ac{noc} packet format}
\label{fig:NoC packet format}
\end{figure}
\fi


When computing an \ac{ann}, a group of \acp{ssc} will be assigned to the \ac{ann} and the individual \acp{an} will be distributed over the group of \acp{ssc}.
The \ac{noc} is employed to replicate \ac{an} states from one \ac{ssc} to other \acp{ssc} in the group.
For the cases studied where the system is supporting multiple \acp{ann}, each \ac{ann} will be assigned to groups containing six to eight \acp{ssc}.
In this case, the \acp{ssc} in the group will be within four \ac{noc} hops.
When the \ac{pe} passes the \ac{an} states back to the manager, the results may written to the local \ac{dram} and also sent out the \ac{noc}.
The required time to distribute the packets is dictated in part by the results having to be sent over the \ac{noc} before the \ac{pe} completes processing the next set of \acp{an}.
%The required time it takes the \ac{noc} to distribute the packets requirement is dictated in part by the results having to be sent over the \ac{noc} in the time taken for the \ac{pe} to process the next set of \acp{an}.
The time taken to process a group of \acp{an} is proportional to the number of pre-synaptic \acp{an} in locally- or fully-connected layers (for pooling layers see Appendix \ref{sec:Max pooling}).
For the baseline \ac{ann} (see Table \ref{tab:Baseline Layer Configuration}), the minimum pre-synaptic fanin is 363, which means the \ac{noc} must transport the result packets in approximately 363 clocks.
The \ac{noc} packet shown in Figure \ref{fig:NoC packet format} contains a header cycle, 16 data cycles and one option cycle. 
Assuming a group of eight \acp{ssc} have been assigned to an \ac{ann}, a result will need to be replicated to up to seven other \acp{ssc}.
This will require four option cycles to carry the seven storage descriptors. This results in an \ac{noc} packet size of 21 clock cycles.
The verification identified that the system introduces an inter-frame gap of two cycles which means it takes on average 23 cycles to transport a packet between \acp{ssc}.
The time taken to transport a packet over one \ac{noc} hop is called a frame time.
Because of the store-and-forward behavior of the \ac{noc} design, when a group of \ac{an} states needs to be replicated to all other \acp{ssc}, it takes six frame times in the network for all the packets to reach their destinations,
requiring a total of 138 cycles, which is within the 363 cycle requirement.

This work defines the effective \ac{noc} bandwidth as being the total number of bits that are distributed within the group over the time it takes to distribute all the packets.
For the case studied, there are 8 packets with 32 words per packet. % resulting in \SI[per-mode=symbol]{1}{\kilo\bit\per packet}.
Based on the seven frame times to transport the packets to all destination \acp{ssc}, this means the \ac{noc} has an effective bandwidth of \SI[per-mode=symbol]{30}{\giga\bit\per\second} \eqref{eq:nocEffectiveBandwidth}.
The \ac{noc} port databus width is 64 resulting in a raw bandwidth of \SI[per-mode=symbol]{32}{\giga\bit\per port} \eqref{eq:rawPortBandwidth}. % and the raw mesh bandwidth is \SI[per-mode=symbol]{256}{\giga\bit\per\second} \eqref{eq:rawMeshBandwidth}.
% {2} means 2 columns
% & alternates R-L-R-L
\begin{alignat}{5} 
  \text{NoC port bandwidth}         & = \frac{b_i}{t_c}                                         && = \frac{64}{\num{2d-9}}                                   && =  \SI[per-mode=symbol]{32}{\giga \bit \per \second}       \label{eq:rawPortBandwidth}               \\[-10pt]
                                                                                                                                                                                                                                                            \notag   \\[-10pt]                                                 
  \text{NoC effective bandwidth}    & = \frac{N_p \cdot W_p \cdot b_w}{N_f \cdot C_f \cdot t_c} && = \frac{8 \cdot 32 \cdot 32}{6 \cdot 23 \cdot \num{2d-9}} && \approx \SI[per-mode=symbol]{30}{\giga \bit \per \second}  \label{eq:nocEffectiveBandwidth}          \\[-10pt]
                                                                                                                                                                                                                                                            \notag   \\[-10pt]
%  \text{NoC mesh bandwidth }        & = \frac{N_s \cdot b_i}{t_c}                               && = \frac{8 \cdot 64}{\num{2d-9}}                           && =  \SI[per-mode=symbol]{256}{\giga \bit \per \second}      \label{eq:rawMeshBandwidth}               \\[0pt]
  &&&\text{where }   &&N_p \text{ is the total number of \ac{ssc} packets}    \notag \\[-5pt]
  &                &&&&W_p \text{ is the number of words per packet}          \notag \\[-5pt]
  &                &&&&N_f \text{ is the number of frame times}               \notag \\[-5pt]
  &                &&&&C_f \text{ is the number of cycles per frame }         \notag \\[-5pt]
  &                &&&&b_i \text{ is the number of data bits per interface}   \notag \\[-5pt]
  &                &&&&b_w \text{ is the number of bits per word          }   \notag \\[-5pt]
  &                &&&&t_c \text{ is the cycle time}                          \notag
\end{alignat}
\iffalse
\vspace{-10mm}
\begin{alignat}{2} 
  \text{NoC port bandwidth} & = \frac{b_i}{t_c} \notag \\
                                    & = \frac{64}{\num{2d-9}} =  \SI[per-mode=symbol]{32}{\giga \bit \per \second}  \label{eq:rawPortBandwidth}\\
  \text{where } &b_i \text{ is the number of data bits per \ac{noc} interface} \notag \\
                &t_c \text{ is the cycle time} \notag
\end{alignat}
\vspace{-10mm}
\begin{alignat}{2} 
  \text{Raw mesh bandwidth} & = \frac{N_s \cdot b_i}{t_c} \notag \\
                                    & = \frac{8 \cdot 64}{\num{2d-9}} =  \SI[per-mode=symbol]{256}{\giga \bit \per \second} \label{eq:rawMeshBandwidth} \\
  \text{where } &N_s \text{ number of \acp{ssc} assigned to an \ac{ann}} \notag \\
                &b_i \text{ is the number of data bits per \ac{noc} interface} \notag \\
                &t_c \text{ is the cycle time} \notag
\end{alignat}
\fi

%\subsubsection{NoC Future Work}
%\label{sec:NoC future work}

The \ac{noc} designed in this work was primarily to create a representative \ac{noc} for the area and power analysis.
There are situations based on poor \ac{ssc} assignment where excessive frame hops are required and could potentially violate the maximum transport time.
Each \ac{noc} has a forwarding table indicating which port should be used to send to a destination \ac{ssc} or the host.
The forwarding table has a default setting based on shortest path but it is anticipated that it be dynamically reconfigured by the host.
It is anticipated that the forwarding table configuration will be based on the \ac{ann} \acp{ssc} assignments to provide more optimum routing given the \ac{an} state replication associated with a particular operation.
An analysis of the hop usage will likely suggest a more optimal routing table rather than the fixed shortest path currently employed. This will be left to future work.


% ----------------------------------------------------------------------------------------------------
\section{Summary}
\label{sec:Overview Summary}

A control and data flow diagram of the stack showing the 64 sub-system columns can be seen in Figure \ref{fig:FlowDiagram}.
\begin{figure}[!t]
% the [] contains position info e.g. [!t] means here
\centering
\captionsetup{justification=centering}
\centerline{
\mbox{\includegraphics[width=.8\linewidth]{FlowDiagram.jpg}}
}
\caption{System Flow Diagram}
\label{fig:FlowDiagram}
\end{figure}


One of the primary objectives is to ensure the system can maintain the required average bandwidth (see Table \ref{tab:Bandwidth and Storage Design Requirements}) while operating directly out of \ac{dram} over a range of pre-synaptic fanins.
To achieve this the system decodes instructions and concurrently sends configuration information to various system functions.
It concurrently pre-fetches and pipelines data to absorb the latencies associated with \ac{dram}.
All system functions pipeline their configuration data to ensure the main processing pipeline is not starved of data and/or operations.
This parallelism allows this system to constantly stream data while results from previous operations are being processed, broadcast to other \acp{ssc} and written back to \ac{ssc} memory.
The instructions, the structures for describing the operations and the structures describing how data is retrieved and stored have been designed to provide extensibility.
A detailed description of the instruction architecture and data structures is given in Chapter \ref{sec:System Operations}.
The baseline \ac{ann} described in Table \ref{tab:Baseline Layer Configuration} was used to define a collection of pre-synaptic fanin tests and those tests were used to ensure the average bandwidth can be maintained.
The results of those tests can be seen in Chapter \ref{sec:Results}.


The second objective is to determine if an extensible \ac{3dic} system can be designed employing a customized \ac{3ddram}.
The \ac{3ddram} employed is the \ac{diram4} and estimated areas are extracted from data provided by Tezzaron\textregistered~\cite{patti2014}.
The feasibility of the customizations has been verified with consultation with Tezzaron\textregistered.
The physical details for the \ac{rtl} design of the primary modules are given in Chapter \ref{sec:Detailed System Description}.
The overall area details with respect to the \ac{3dic} stack are shown in Chapter \ref{sec:Results}.



